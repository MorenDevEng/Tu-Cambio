<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Swap VES ⇄ USD</title>
    <link rel="icon" type="icon" href="./static/img/cambio.png">
    <link rel="stylesheet" href="./static/css/output.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="./static/js/alertas_web.js"></script>
</head>
<body class="bg-slate-900 text-white min-h-screen flex flex-col items-center justify-center p-4">
    <main class="max-w-md w-full space-y-6">
        <!-- Header -->
        <header class="text-center">
            <h1 class="text-3xl font-bold text-blue-400">Swap VES ⇄ USD</h1>
            <p class="text-gray-400 mt-2">Tasa basada en BCV + comparación con USDT (Binance)</p>
        </header>

        <!-- Tarjeta de Tasas -->
        <section class="bg-gray-800 rounded-2xl shadow-xl p-6">
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-gray-700 rounded-xl p-4 text-center">
                    <div class="text-sm text-gray-400">VES/USD (BCV)</div>
                    <div class="text-2xl font-bold text-white"><span class="precio_bcv">{{ bcv_valor }}</span> Bs</div>
                </div>
                <div class="bg-gray-700 rounded-xl p-4 text-center">
                    <div class="text-sm text-gray-400">VES/USDT (Binance)</div>
                    <div class="text-2xl font-bold text-white"><span class="precio_usdt">{{ usdt_valor }}</span> Bs</div>
                </div>
            </div>
            <div class="mt-4 text-center">
                <span class="text-sm text-green-400">
                    Dif: <span class="diferencia">{{ "%.2f"|format(usdt_valor - bcv_valor) }}</span> Bs
                </span>
            </div>
        </section>

        <!-- Formulario SWAP -->
        <form id="swapForm" class="bg-gray-800 rounded-2xl shadow-xl p-6 space-y-4">
            <!-- From -->
            <div>
                <label class="block text-sm font-medium text-gray-400 mb-2">From</label>
                <div class="flex items-center space-x-2">

                    <!-- LOGO DE BANDERA DE VENEZUELA -->
                    <div class="w-12 h-8">
                        <img id="icon-bin-sup" src="./static/img/binance.png" class="hidden scale-125 " alt="currency-binance">
                        <img id="icon-usd-sup" src="./static/img/usa.png" class="hidden w-full h-full" alt="currency-bcv">
                        <img id="icon-ves-sup" src="./static/img/VE_C.png" class="w-full h-full" alt="venezuela-bandera">
                    </div>
                    
                    <input type="number" id="fromAmount" name="fromAmount" step="0.01" min="0" class="w-full p-4 text-xl bg-gray-900 border border-gray-700 rounded-2xl focus:ring-2 focus:ring-blue-500 focus:border-transparent [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none" placeholder="0.00" required>
                    <select id="fromCurrency" name="fromCurrency" class="bg-gray-900 border border-gray-700 rounded-2xl p-2 text-xl">
                        <option value="VES">VES</option>
                        <option class="hidden" value="USD">USD</option>
                        <option class="hidden" value="USDT">USDT</option>
                    </select>
                </div>
            </div>

            
            <!-- Botón de Intercambiar -->
            <div class="flex justify-center">
                <button type="button" id="swapButton" class="bg-gray-700 hover:bg-gray-600 rounded-full p-3 transition-all duration-200">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                    </svg>
                </button>
            </div>

            <!-- To -->
            <div>
                <label class="block text-sm font-medium text-gray-400 mb-2">To</label>

                <div class="flex items-center space-x-3 bg-gray-900 border border-gray-700 rounded-2xl p-3">
                    
                    <!-- Icono -->
                    <div class="w-10 h-6">
                        <img id="icon-bin-inf" src="./static/img/binance.png" class="hidden scale-125 " alt="currency-binance">
                        <img id="icon-usd-inf" src="./static/img/usa.png" class="w-full h-full" alt="currency-bcv">
                        <img id="icon-ves-inf" src="./static/img/VE_C.png" class="hidden w-6 h-6" alt="venezuela-bandera">
                    </div>  


                    <!-- Amount -->
                    <input
                        type="number"
                        id="toAmount"
                        name="toAmount"
                        step="0.01"
                        min="0"
                        class="w-full text-xl bg-transparent outline-none"
                        placeholder="0.00"
                        readonly
                    >

                    <!-- Currency -->
                    <select
                        id="toCurrency"
                        name="toCurrency"
                        class="bg-gray-800 border border-gray-700 rounded-xl px-3 py-1 text-xl"
                    >
                        <option value="USD" selected>USD</option>
                        <option value="USDT">USDT</option>
                        <option class="hidden" value="VES">VES</option>
                    </select>
                </div>

                <!-- Fuente -->
                <div class="flex-row items-center mt-2 text-xs text-gray-400">
                    <div class="flex items-center">
                        <img src="./static/img/binance.png" class="w-6 h-6 mr-1 mb-1">
                        <span>Binance P2P</span>
                    </div>
                    <div class="flex items-center">
                        <img id="icon-usd" src="./static/img/usa.png" class="w-4 h-4 ml-1 mr-2">
                        <span>Banco Central de Venezuela</span>
                    </div>

                </div>
            </div>


            <!-- Tasas Abajo -->
            <div class="text-center text-sm text-gray-400">
                <p>1 USD = <span class="precio_bcv">{{ bcv_valor }}</span> VES</p>
                <p>1 USDT = <span class="precio_usdt">{{ usdt_valor }}</span> VES</p>
            </div>

            <!-- Detalles de Transacción (Acordeón Simple) -->
            <details class="text-sm">
                <summary class="cursor-pointer text-gray-400 hover:text-white">Detalles de la transacción</summary>
                <div class="mt-2 space-y-1">
                    <p>Tasa de cambio actual: <span id="tasa-cambio"></span> Bs/USD</p>
                    <p>Total a recibir: <span id="totalReceive">0.00</span></p>
                </div>
            </details>

            <!-- Botón Limpiar -->
            <button type="button" id="Boton-Limpiador" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-4 rounded-2xl transition-all duration-200">
                Limpiar
            </button>
        </form>
    </main>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <script>
                    if( '{{ category }}' == 'danger' ){
                        mensajeErrores(`{{ message }}`);
                    }
                    else if ('{{ category }}' == 'warning') {
                        mensajeErrore(`{{ message }}`);
                    } 
                </script>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- JavaScript -->
    <script>
        const fromAmount = document.getElementById('fromAmount');
        const toAmount = document.getElementById('toAmount');
        const fromCurrency = document.getElementById('fromCurrency');
        const toCurrency = document.getElementById('toCurrency');
        const swapButton = document.getElementById('swapButton');
        const totalReceive = document.getElementById('totalReceive');
        const tasaDeCambio = document.getElementById('tasa-cambio');
        const botonLimpiador = document.getElementById('Boton-Limpiador');

        // Imagenes inferiores de To
        const imgBinanceInferior = document.getElementById('icon-bin-inf');
        const imgUSDInferior = document.getElementById('icon-usd-inf');
        const imgVESInferior = document.getElementById('icon-ves-inf');

        // Imagenes de la parte superior From
        const imgBinanceSuperior = document.getElementById('icon-bin-sup');
        const imgVESSuperior = document.getElementById('icon-ves-sup');
        const imgUSDSuperior = document.getElementById('icon-usd-sup');

        let bcvRate = {{ bcv_valor }};
        let usdtRate = {{ usdt_valor }};
        
        // Evento para calcular en tiempo real
        toCurrency.addEventListener('change', () => {
            calculateTo()
        })

        // Función para calcular el monto To
        function calculateTo() {
            const fromVal = parseFloat(fromAmount.value) || 0;
            const fromCurr = fromCurrency.value;
            const toCurr = toCurrency.value;

            let result = 0;

            if (fromCurr === 'VES' && toCurr === 'USD') {
                imgBinanceInferior.classList.add('hidden')
                imgUSDInferior.classList.remove('hidden')
                tasaDeCambio.textContent = bcvRate
                result = fromVal / bcvRate;

            } else if (fromCurr === 'VES' && toCurr === 'USDT') {
                imgUSDInferior.classList.add('hidden')
                imgBinanceInferior.classList.remove('hidden')
                tasaDeCambio.textContent = usdtRate
                result = fromVal / usdtRate;

            } else if (fromCurr === 'USD' && toCurr === 'VES') {

                imgBinanceSuperior.classList.add('hidden')
                imgUSDSuperior.classList.remove('hidden')
                tasaDeCambio.textContent = bcvRate
                result = bcvRate * fromVal;

            } else if (fromCurr === 'USDT' && toCurr === 'VES') {

                imgBinanceSuperior.classList.remove('hidden')
                imgUSDSuperior.classList.add('hidden')
                tasaDeCambio.textContent = usdtRate
                result = usdtRate * fromVal;
            } 

            if (!fromAmount.value) {
                toAmount.value = '';
                totalReceive.textContent = '';
                return;
            };

            toAmount.value = result.toFixed(2);
            totalReceive.textContent = result.toFixed(2);

        };


        // Evento al clickear el boton de swap
        swapButton.addEventListener('click', () => {
            
            opcionSeleccionarFrom = fromCurrency.options
            opcionSeleccionarTo = toCurrency.options

            // SE MUESTRAN AHORA LAS OPCIONES OCULTAS DEL FROM
            for (var i = 0; i < opcionSeleccionarFrom.length; i++) {
                if (opcionSeleccionarFrom[i].classList.contains('hidden')) {
                    opcionSeleccionarFrom[i].classList.remove('hidden')

                    if (opcionSeleccionarFrom[i].value === 'USD' && !(opcionSeleccionarFrom[i].classList.contains('hidden'))) {
                        opcionSeleccionarFrom[i].selected = true
                        imgVESSuperior.classList.add('hidden')
                        imgUSDSuperior.classList.remove('hidden')

                    
                    } else if (opcionSeleccionarFrom[i].value === 'VES' && !(opcionSeleccionarFrom[i].classList.contains('hidden'))) {
                        opcionSeleccionarFrom[i].selected = true
                        imgVESSuperior.classList.remove('hidden')
                        imgBinanceSuperior.classList.add('hidden')
                        imgUSDSuperior.classList.add('hidden')
                    };

                } else {
                    opcionSeleccionarFrom[i].classList.add('hidden')
                };

            };

            // SE MUESTRAN AHORA LAS OPCIONES OCULTAS DEL TO
            for (var i = 0; i < opcionSeleccionarTo.length; i++) {
                if (opcionSeleccionarTo[i].classList.contains('hidden')) {
                    opcionSeleccionarTo[i].classList.remove('hidden')

                    if (opcionSeleccionarTo[i].value === 'VES' && !(opcionSeleccionarTo[i].classList.contains('hidden'))) {
                        opcionSeleccionarTo[i].selected = true
                        imgVESInferior.classList.remove('hidden')
                        imgUSDInferior.classList.add('hidden')
                        imgBinanceInferior.classList.add('hidden')

                    
                    } else if (opcionSeleccionarTo[i].value === 'USD' && !(opcionSeleccionarTo[i].classList.contains('hidden'))) {
                        opcionSeleccionarTo[i].selected = true
                        imgUSDInferior.classList.remove('hidden')
                        imgVESInferior.classList.add('hidden')
                        imgBinanceInferior.classList.add('hidden')

                    };

                } else {
                    opcionSeleccionarTo[i].classList.add('hidden')
                };

            };

            limpiarInput()
            
        });

        // Evento para calcular en tiempo real
        fromAmount.addEventListener('input', calculateTo);
        fromCurrency.addEventListener('change', () => {
            // Ajustar toCurrency automáticamente
            toCurrency.value = fromCurrency.value === 'VES' ? 'USD' : 'VES';
            calculateTo();
        });

        botonLimpiador.addEventListener('click', () => {
            limpiarInput()
        })

        function limpiarInput(){
            fromAmount.value = '';
            toAmount.value = ''
            totalReceive.textContent = '';
        }

        async function actualizarTasas() {
            const res = await fetch('/price/ves-prices');
            if (!res.ok) throw new Error('No response');
            const data = await res.json();

            usdtRate = (data.usdt_valor).toFixed(2);
            bcvRate = (data.bcv_valor).toFixed(2);

            actulizadorUSDT = document.querySelectorAll('.precio_usdt');
            actulizadorBCV = document.querySelectorAll('.precio_bcv');
            

            actulizadorBCV.forEach(element => {
                element.textContent = bcvRate; 
            });

            actulizadorUSDT.forEach(element => {
                element.textContent = usdtRate;
            });

            valorDiferencia = document.querySelector('.diferencia');
            valorDiferencia.textContent = (usdtRate - bcvRate).toFixed(2);
            
        }

        // Cada 60 segundos
        setInterval(actualizarTasas, 60000);

        // Inicializar
        calculateTo();
    </script>

    
</body>
</html>